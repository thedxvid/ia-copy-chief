
import { supabase } from '@/integrations/supabase/client';
import type { QuizQuestion } from '@/hooks/useQuizTemplates';

export interface QuizData {
  [key: string]: QuizQuestion[];
}

export const getQuizTitle = (quizType: string): string => {
  const titles = {
    vsl: 'V√≠deo de Vendas (VSL)',
    product: 'Estrutura de Oferta',
    landing: 'Landing Page',
    ads: 'An√∫ncios Pagos',
    email_marketing: 'Email Marketing',
    sales_letter: 'Carta de Vendas',
    social_media: 'Social Media'
  };
  
  return titles[quizType as keyof typeof titles] || 'Quiz Personalizado';
};

export const getQuizQuestions = async (quizType: string): Promise<QuizQuestion[]> => {
  console.log(`üîç [QuizQuestions] Carregando perguntas para o tipo: ${quizType}`);
  
  // Se for um template personalizado
  if (quizType.startsWith('template_')) {
    const templateId = quizType.replace('template_', '');
    console.log(`üìã [QuizQuestions] Carregando template personalizado ID: ${templateId}`);
    
    try {
      const { data: template, error } = await supabase
        .from('quiz_templates')
        .select('questions, title')
        .eq('id', templateId)
        .eq('is_active', true)
        .single();

      if (error) {
        console.error('‚ùå [QuizQuestions] Erro ao carregar template:', error);
        throw error;
      }

      if (!template) {
        console.error('‚ùå [QuizQuestions] Template n√£o encontrado ou inativo');
        throw new Error('Template n√£o encontrado ou inativo');
      }

      console.log(`‚úÖ [QuizQuestions] Template carregado: ${template.title}`);
      
      // Processar perguntas do template
      let questions: QuizQuestion[] = [];
      if (Array.isArray(template.questions)) {
        questions = template.questions as unknown as QuizQuestion[];
      } else {
        console.warn('‚ö†Ô∏è [QuizQuestions] Perguntas do template n√£o est√£o no formato esperado');
      }

      console.log(`üìù [QuizQuestions] ${questions.length} perguntas carregadas do template`);
      return questions;
    } catch (error) {
      console.error('üí• [QuizQuestions] Erro ao carregar perguntas do template:', error);
      throw error;
    }
  }
  
  // Quiz padr√µes - primeiro tentar buscar do banco de dados
  console.log(`üìö [QuizQuestions] Buscando quiz padr√£o no banco: ${quizType}`);
  
  try {
    const { data: template, error } = await supabase
      .from('quiz_templates')
      .select('questions, title')
      .eq('quiz_type', quizType)
      .eq('is_active', true)
      .eq('is_default', true)
      .single();

    if (!error && template) {
      console.log(`‚úÖ [QuizQuestions] Template padr√£o encontrado no banco: ${template.title}`);
      
      let questions: QuizQuestion[] = [];
      if (Array.isArray(template.questions)) {
        questions = template.questions as unknown as QuizQuestion[];
      }
      
      console.log(`üìù [QuizQuestions] ${questions.length} perguntas carregadas do banco`);
      return questions;
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è [QuizQuestions] Erro ao buscar template padr√£o no banco:', error);
  }
  
  // Fallback para perguntas hardcoded
  console.log(`üìã [QuizQuestions] Usando perguntas hardcoded para: ${quizType}`);
  
  const standardQuestions = {
    vsl: [
      {
        id: 'product',
        question: 'Qual √© o nome do seu produto ou servi√ßo?',
        type: 'text' as const,
        required: true,
        placeholder: 'Ex: Curso de Marketing Digital'
      },
      {
        id: 'target',
        question: 'Quem √© o seu p√∫blico-alvo ideal?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Descreva detalhadamente seu cliente ideal, suas dores, desejos e caracter√≠sticas demogr√°ficas'
      },
      {
        id: 'problem',
        question: 'Qual √© o principal problema que seu produto resolve?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Descreva o problema de forma clara e espec√≠fica'
      },
      {
        id: 'benefit',
        question: 'Qual √© o principal benef√≠cio que seu produto oferece?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Qual transforma√ß√£o ou resultado seu cliente ter√°?'
      },
      {
        id: 'proof',
        question: 'Que prova ou credibilidade voc√™ tem para oferecer?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Depoimentos, casos de sucesso, certifica√ß√µes, experi√™ncia...'
      },
      {
        id: 'price',
        question: 'Qual √© o pre√ßo do seu produto?',
        type: 'text' as const,
        required: true,
        placeholder: 'Ex: R$ 497 ou 12x de R$ 49,70'
      },
      {
        id: 'urgency',
        question: 'Que elemento de urg√™ncia ou escassez voc√™ pode usar?',
        type: 'textarea' as const,
        required: false,
        placeholder: 'Promo√ß√£o por tempo limitado, vagas limitadas, b√¥nus exclusivos...'
      },
      {
        id: 'guarantee',
        question: 'Que garantia voc√™ oferece?',
        type: 'text' as const,
        required: false,
        placeholder: 'Ex: Garantia de 30 dias ou seu dinheiro de volta'
      },
      {
        id: 'objections',
        question: 'Quais s√£o as principais obje√ß√µes do seu p√∫blico?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Liste as d√∫vidas e resist√™ncias mais comuns dos clientes'
      },
      {
        id: 'cta',
        question: 'Qual √© a sua chamada para a√ß√£o?',
        type: 'text' as const,
        required: true,
        placeholder: 'Ex: Compre Agora, Inscreva-se Hoje, Acesse J√°'
      }
    ],
    
    product: [
      {
        id: 'product_name',
        question: 'Qual √© o nome do seu produto?',
        type: 'text' as const,
        required: true,
        placeholder: 'Nome completo do produto'
      },
      {
        id: 'target_audience',
        question: 'Descreva seu p√∫blico-alvo ideal',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Demografia, psicografia, problemas e desejos'
      },
      {
        id: 'value_proposition',
        question: 'Qual √© sua proposta de valor √∫nica?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'O que torna seu produto √∫nico e valioso'
      },
      {
        id: 'main_benefits',
        question: 'Liste os 3 principais benef√≠cios',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Benef√≠cios claros e mensur√°veis'
      },
      {
        id: 'pricing_strategy',
        question: 'Qual √© sua estrat√©gia de pre√ßo?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Pre√ßo, formas de pagamento, compara√ß√µes de valor'
      },
      {
        id: 'bonuses',
        question: 'Que b√¥nus voc√™ pode incluir?',
        type: 'textarea' as const,
        required: false,
        placeholder: 'Liste b√¥nus valiosos que complementam a oferta'
      },
      {
        id: 'guarantee_terms',
        question: 'Que garantia voc√™ oferece?',
        type: 'text' as const,
        required: true,
        placeholder: 'Tipo e prazo da garantia'
      },
      {
        id: 'scarcity_elements',
        question: 'Elementos de escassez ou urg√™ncia',
        type: 'textarea' as const,
        required: false,
        placeholder: 'Tempo limitado, vagas limitadas, pre√ßo promocional...'
      },
      {
        id: 'social_proof',
        question: 'Que prova social voc√™ tem?',
        type: 'textarea' as const,
        required: false,
        placeholder: 'Depoimentos, n√∫meros, casos de sucesso'
      },
      {
        id: 'call_to_action',
        question: 'Qual √© sua chamada principal para a√ß√£o?',
        type: 'text' as const,
        required: true,
        placeholder: 'Ex: Garantir Minha Vaga Agora'
      }
    ],
    
    landing: [
      {
        id: 'produto',
        question: 'Qual produto voc√™ est√° promovendo?',
        type: 'text' as const,
        required: true,
        placeholder: 'Nome do produto ou servi√ßo'
      },
      {
        id: 'publico_alvo',
        question: 'Quem √© seu p√∫blico-alvo?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Descreva detalhadamente seu cliente ideal'
      },
      {
        id: 'problema_principal',
        question: 'Qual o principal problema que seu produto resolve?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'O problema mais urgente do seu p√∫blico'
      },
      {
        id: 'solucao_oferecida',
        question: 'Como seu produto resolve este problema?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'A solu√ß√£o espec√≠fica que voc√™ oferece'
      },
      {
        id: 'beneficios_principais',
        question: 'Quais s√£o os 3 principais benef√≠cios?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Benef√≠cios tang√≠veis e mensur√°veis'
      },
      {
        id: 'diferencial_competitivo',
        question: 'O que torna seu produto √∫nico?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Seu diferencial em rela√ß√£o √† concorr√™ncia'
      },
      {
        id: 'prova_social',
        question: 'Que prova social voc√™ pode usar?',
        type: 'textarea' as const,
        required: false,
        placeholder: 'Depoimentos, casos de sucesso, n√∫meros impressionantes'
      },
      {
        id: 'oferta_especifica',
        question: 'Qual √© sua oferta espec√≠fica?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Pre√ßo, forma de pagamento, b√¥nus, garantia'
      },
      {
        id: 'urgencia_escassez',
        question: 'Elementos de urg√™ncia ou escassez',
        type: 'textarea' as const,
        required: false,
        placeholder: 'Tempo limitado, vagas limitadas, desconto especial'
      },
      {
        id: 'cta_principal',
        question: 'Qual √© sua call-to-action principal?',
        type: 'text' as const,
        required: true,
        placeholder: 'Ex: Quero Come√ßar Agora, Garantir Minha Vaga'
      }
    ],
    
    ads: [
      {
        id: 'objetivo_campanha',
        question: 'Qual √© o objetivo da sua campanha?',
        type: 'radio' as const,
        required: true,
        options: [
          'Gerar leads (capturar contatos)',
          'Vendas diretas',
          'Reconhecimento de marca',
          'Tr√°fego para site/blog',
          'Engajamento nas redes sociais'
        ]
      },
      {
        id: 'publico_segmentado',
        question: 'Descreva seu p√∫blico-alvo para segmenta√ß√£o',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Idade, localiza√ß√£o, interesses, comportamentos, demografias'
      },
      {
        id: 'produto_promovido',
        question: 'Que produto/servi√ßo voc√™ est√° promovendo?',
        type: 'text' as const,
        required: true,
        placeholder: 'Nome e breve descri√ß√£o'
      },
      {
        id: 'proposta_valor',
        question: 'Qual √© sua proposta de valor em uma frase?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Benef√≠cio principal de forma clara e impactante'
      },
      {
        id: 'emocao_despertar',
        question: 'Que emo√ß√£o voc√™ quer despertar?',
        type: 'radio' as const,
        required: true,
        options: [
          'Desejo/Aspira√ß√£o',
          'Medo/Urg√™ncia',
          'Curiosidade',
          'Confian√ßa/Seguran√ßa',
          'Alegria/Divers√£o'
        ]
      },
      {
        id: 'call_to_action',
        question: 'Qual a√ß√£o voc√™ quer que tomem?',
        type: 'text' as const,
        required: true,
        placeholder: 'Ex: Clique aqui, Saiba mais, Compre agora'
      },
      {
        id: 'orcamento_diario',
        question: 'Qual seu or√ßamento di√°rio aproximado?',
        type: 'radio' as const,
        required: false,
        options: [
          'At√© R$ 50/dia',
          'R$ 50 - R$ 100/dia',
          'R$ 100 - R$ 300/dia',
          'R$ 300 - R$ 500/dia',
          'Acima de R$ 500/dia'
        ]
      },
      {
        id: 'plataforma_prioritaria',
        question: 'Qual plataforma √© priorit√°ria?',
        type: 'radio' as const,
        required: true,
        options: [
          'Facebook/Instagram',
          'Google Ads',
          'TikTok',
          'LinkedIn',
          'YouTube'
        ]
      },
      {
        id: 'tom_linguagem',
        question: 'Que tom de linguagem usar?',
        type: 'radio' as const,
        required: true,
        options: [
          'Formal e profissional',
          'Casual e amig√°vel',
          'Divertido e descontra√≠do',
          'Urgente e persuasivo',
          'Educativo e informativo'
        ]
      },
      {
        id: 'diferencial_concorrencia',
        question: 'Como voc√™ se diferencia da concorr√™ncia?',
        type: 'textarea' as const,
        required: true,
        placeholder: 'Pontos √∫nicos que te destacam no mercado'
      }
    ]
  };

  const questions = standardQuestions[quizType as keyof typeof standardQuestions];
  
  if (!questions) {
    console.warn(`‚ö†Ô∏è [QuizQuestions] Nenhuma pergunta encontrada para o tipo: ${quizType}`);
    return [];
  }

  console.log(`‚úÖ [QuizQuestions] ${questions.length} perguntas padr√£o carregadas para ${quizType}`);
  return questions;
};

export const invalidateQuizTemplatesCache = () => {
  console.log('üóëÔ∏è [QuizQuestions] Cache de templates invalidado');
};
